<?php

/**
 * Implements hook_menu().
 */
function synch_users_from_external_database_menu() {
  $items['start'] = array(
    'title' => 'Start synch',
    'page callback' => 'start_synch_users_from_external_database',
    'access callback' => TRUE,
  );

  return $items;
}

function start_synch_users_from_external_database() {
  watchdog("synch_users_from_external_database","Start create queue");
  
  $queue = DrupalQueue::get('synch_users_from_external_database');  

  $conn=oci_connect("user", "pass", "tns");
  $stid = oci_parse($conn, "SELECT username, fullname FROM \"User\" WHERE ROWNUM < 6");
  oci_execute($stid);
  
  while ($row = oci_fetch_array($stid)) {
    $queue->createItem($row);
	watchdog("synch_users_from_external_database","Add item to row" . $row['USERNAME']);
  }
}

/**
 * Implements hook_cron_queue_info()
 */
function synch_users_from_external_database_cron_queue_info() {
  $queues['synch_users_from_external_database'] = array(
    'worker callback' => 'synch_users_from_external_database_callback',
    'time' => 30,
	'skip on cron' => TRUE,
  );
  return $queues;
}

/**
 * Worker callback defined in hook_cron_queue_info()
 */
function synch_users_from_external_database_callback($row){
  watchdog("synch_users_from_external_database","Create user: ". $row["USERNAME"]);
  
/*   $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'user')
  ->fieldCondition('field_user_personnel_number', 'value', $row["USERNAME"]);
  $result = $query->execute();
  $users_ids = array_keys($result['user']); */
  

  /**
  * Creating user
  */
  $new_user = array(
    'name' => $row['USERNAME'],
    'mail' => $row['USERNAME'] . "@mail.mail",
    'init' => $row['USERNAME'] . "@mail.mail",
	'field_user_full_name' => array(LANGUAGE_NONE => array(array('value' => $row['USERNAME']))),
	'field_user_surname' => array(LANGUAGE_NONE => array(array('value' => $row['USERNAME']))),
	'field_user_name' => array(LANGUAGE_NONE => array(array('value' => $row['USERNAME']))),
	'field_user_patronymic' => array(LANGUAGE_NONE => array(array('value' => $row['USERNAME']))),
	'field_user_personnel_number' => array(LANGUAGE_NONE => array(array('value' => $row['USERNAME']))),
	'field_user_position' => array(LANGUAGE_NONE => array(array('value' => $row['USERNAME']))),
	'field_user_number_of_department' => array(LANGUAGE_NONE => array(array('value' => $row['USERNAME']))),
	'field_user_title_of_department' => array(LANGUAGE_NONE => array(array('value' => $row['USERNAME']))),
	'field_user_number_of_bureau' => array(LANGUAGE_NONE => array(array('value' => $row['USERNAME']))),
	'field_user_title_of_bureau' => array(LANGUAGE_NONE => array(array('value' => $row['USERNAME']))),
	'field_user_work_phone' => array(LANGUAGE_NONE => array(array('value' => $row['USERNAME']))),
	'field_user_is_working' => array('und' => array(0 => array('value' => 1))),
	'field_user_with_login' => array('und' => array(0 => array('value' => 0))),
    'status' => 1,
    'access' => REQUEST_TIME,
  );
  $account = user_save(null, $new_user);
}
