<?php

/**
 * Implements hook_cron_queue_info().
 */
function synch_users_cron_queue_info() {
  $queue['synch_users_queue'] = array(
    'worker callback' => 'synch_users_item_process',
    'time' => 10,
  );
  return $queue;
}

/**
 * Implements hook_cron().
 */
function synch_users_cron() {
   watchdog("synch_users","Synch users cron");
  // Loading users data from external database
  $items = synch_users_load_data();
 
  if ($items) {
    // Create queue
    $queue = DrupalQueue::get('synch_users_queue');
	$number_of_items_in_queue = $queue->numberOfItems();
	watchdog("synch_users","Number of items: " . $number_of_items_in_queue);
	
    // Filling queue by items from external database
    foreach ($items as $item) {
      $queue->createItem($item);
	  $number_of_items_in_queue = $queue->numberOfItems();
	  watchdog("synch_users","Number of items after create item: " . $number_of_items_in_queue);
    }
  }
}
function synch_users_item_process($data) {
  watchdog("synch_users","Process item: " . $data['login']);

  $query = new EntityFieldQuery();
  $result = $query
    ->entityCondition('entity_type', 'user')
    ->fieldCondition('field_user_personnel_number', 'value', $data['personnel_number'])
    ->execute();
  if ($result) {	
    $uids = array_keys($result['user']);
    foreach ($uids as $uid) {
	  watchdog("synch_users","Users already exists: ". $uid);
	  update_user($uid,$data);
	}
    } else {
	  create_user($data);
    }  
}

/**
 * Get users data
 */
function synch_users_load_data() {
  $users = array(
    array(
      "login" => "JuravelNazar84",
      "email" => "JuravelNazar84@mail.ru",
      "personnel_number" => "023491"
    ),
	array(
      "login" => "FrolovLyubosmyisl280",
      "email" => "FrolovLyubosmyisl280@mail.ru",
      "personnel_number" => "323023"
    ),
	array(
	  "login" => "SekunovSergey72",
      "email" => "SekunovSergey72@mail.ru",
      "personnel_number" => "012981"
    ),
	array(
	  "login" => "OrlovaElvira96",
      "email" => "OrlovaElvira96@mail.ru",
      "personnel_number" => "971011"
    ),
	array(
	  "login" => "AndronovArseniy316",
      "email" => "AndronovArseniy316@mail.ru",
      "personnel_number" => "001221"
    ),
	array(
	  "login" => "MarkovaMilena229",
      "email" => "MarkovaMilena229@mail.ru",
      "personnel_number" => "980111"
    ),
	array(
	  "login" => "KonyaginaVera355",
      "email" => "KonyaginaVera355@mail.ru",
      "personnel_number" => "123852"
    ),
	array(
	  "login" => "ZaharovaAnfisa312",
      "email" => "ZaharovaAnfisa312@mail.ru",
      "personnel_number" => "122491"
    ),
	array(
	  "login" => "MarkovAverkiy180",
      "email" => "MarkovAverkiy180@mail.ru",
      "personnel_number" => "563254"
    ),
	array(
	  "login" => "asdATarskayaDjuletta307",
      "email" => "sdTarskayaDjuletta307@mail.ru",
      "personnel_number" => "34564123"
    ),
  );  
return $users;
}

/**
 * Create user
 */
function create_user($data) {
  user_save(NULL, array(
    'name' => $data["login"],
    'mail' => $data["email"],
    'init' => $data["email"],
	'field_user_personnel_number' => array(LANGUAGE_NONE => array(array('value' => $data["personnel_number"]))),
    'status' => 1,
    'roles' => array(DRUPAL_AUTHENTICATED_RID => TRUE),
  ));
  watchdog("synch_users","Created user: " . $data['login']);
}

/**
 * Update user
 */
function update_user($uid,$data) {
  $user_fields = user_load($uid); 
  $user_fields->name = $data['login'];
  $user_fields->mail = $data['email'];
  user_save($user_fields);
}
